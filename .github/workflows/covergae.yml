name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        ref: 'petclinic-junit'

    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: '17'
        distribution: 'adopt'
        maven-version: '3.8.4'

    - name: Download and prepare Keploy binary
      run: |
        curl --silent --location 'https://github.com/keploy/keploy/releases/latest/download/keploy_linux_amd64.tar.gz' | tar xz -C /tmp
        sudo mkdir -p /usr/local/bin && sudo mv /tmp/keploy /usr/local/bin/keploybin

    - name: Build and test with Maven and Keploy
      run: |
        cd spring-petclinic/spring-petclinic-rest
        mvn clean install -Dmaven.test.skip=true
        mvn test

    
    - name: Publish JaCoCo report
      uses: cicirello/jacoco-report@v2
      with:
        jacoco-csv-file: spring-petclinic/spring-petclinic-rest/target/site/e2e-ut-aggregate/jacoco.csv
        report-name: "JaCoCo Coverage Report"
        minimum-coverage: 85
        fail-if-coverage-less-than-minimum: true

    # Add additional steps for coverage threshold enforcement if needed
