name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        ref: 'petclinic-junit'

    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: '17'
        distribution: 'adopt'
        maven-version: '3.8.4'

    - name: Download and prepare Keploy binary
      run: |
        curl --silent --location 'https://github.com/keploy/keploy/releases/latest/download/keploy_linux_amd64.tar.gz' | tar xz -C /tmp
        sudo mkdir -p /usr/local/bin && sudo mv /tmp/keploy /usr/local/bin/keploybin

    - name: Build and test with Maven and Keploy
      run: |
        cd spring-petclinic/spring-petclinic-rest
        mvn clean install -Dmaven.test.skip=true
        sudo -E env PATH="$PATH" keploybin test -c "mvn test" --delay 30 --coverage

    - name: SonarQube Analysis
      run: |
        cd spring-petclinic/spring-petclinic-rest
        mvn clean install -Dmaven.test.skip=true
        sudo -E env PATH="$PATH" keploybin test -c "mvn verify sonar:sonar -Dsonar.projectKey=msil-test-new -Dsonar.coverage.jacoco.xmlReportPaths=target/site/e2e-ut-aggregate/jacoco.xml" --delay 30 --coverage

    # Add additional steps for coverage threshold enforcement if needed
